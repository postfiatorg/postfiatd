# Orchard-PostFiat

Rust implementation of Orchard/Halo2 zero-knowledge privacy features for PostFiat.

## Overview

This crate provides the cryptographic foundation for PostFiat's privacy features, implementing Zcash's Orchard shielded protocol with Halo2 zero-knowledge proofs.

## Structure

```
orchard-postfiat/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs           # Main library entry point
â”‚   â”œâ”€â”€ bundle.rs        # OrchardBundle implementation (currently stub)
â”‚   â””â”€â”€ ffi/
â”‚       â”œâ”€â”€ mod.rs       # FFI module
â”‚       â””â”€â”€ bridge.rs    # cxx bridge definitions (Rust â†” C++)
â”œâ”€â”€ CMakeLists.txt       # CMake integration
â”œâ”€â”€ Cargo.toml           # Rust package configuration
â”œâ”€â”€ build.rs             # Build script (cxx bridge generation)
â””â”€â”€ .gitignore           # Git ignore rules
```

## Building

The crate is automatically built as part of the PostFiat CMake build:

```bash
cd /path/to/postfiatd
mkdir build && cd build
cmake ..
make
```

Or build the Rust crate directly:

```bash
cd orchard-postfiat
cargo build --release
```

## Current Status

**Phase 2 Complete**: Interface skeleton with stub implementations

- âœ… cxx FFI bridge (13 functions)
- âœ… OrchardBundle stub implementation
- âœ… Batch verification stub
- âœ… CMake integration
- ðŸš§ Real Orchard cryptography (Phase 3 - TODO)

## Dependencies

- `orchard = "0.7"` - Zcash Orchard protocol implementation
- `halo2_proofs = "0.3"` - Halo2 zero-knowledge proof system
- `cxx = "1.0"` - Safe Rust/C++ FFI
- `anyhow = "1.0"` - Error handling

See [Cargo.toml](Cargo.toml) for complete dependency list.

## FFI Interface

The crate exposes 13 functions to C++ via cxx bridge:

### Bundle Operations
- `orchard_bundle_parse()` - Parse serialized bundle
- `orchard_bundle_serialize()` - Serialize bundle
- `orchard_bundle_box_clone()` - Clone bundle

### Validation
- `orchard_bundle_is_present()` - Check if bundle exists
- `orchard_bundle_is_valid()` - Validate structure

### Bundle Properties
- `orchard_bundle_get_value_balance()` - Get value balance (tâ†”z flow)
- `orchard_bundle_get_anchor()` - Get Merkle root
- `orchard_bundle_get_nullifiers()` - Get spend nullifiers
- `orchard_bundle_num_actions()` - Count actions

### Proof Verification
- `orchard_verify_bundle_proof()` - Verify Halo2 proof

### Batch Verification
- `orchard_batch_verify_init()` - Initialize batch verifier
- `orchard_batch_verify_add()` - Add bundle to batch
- `orchard_batch_verify_finalize()` - Verify batch

## Usage from C++

```cpp
#include <xrpl/protocol/OrchardBundle.h>

// Parse bundle from transaction
auto bundle = OrchardBundleWrapper::parse(data);

// Check validity
if (!bundle || !bundle->isValid()) {
    return temMALFORMED;
}

// Get value balance
int64_t valueBalance = bundle->getValueBalance();

// Verify proof
uint256 sighash = tx.getSigningHash();
if (!bundle->verifyProof(sighash)) {
    return tefORCHARD_INVALID_PROOF;
}

// Check for double-spends
for (auto const& nf : bundle->getNullifiers()) {
    if (view.exists(keylet::orchardNullifier(nf))) {
        return tefORCHARD_DUPLICATE_NULLIFIER;
    }
}
```

## Build Artifacts (Ignored by Git)

The following files/directories are generated during build and excluded from git:

- `target/` - Rust build output
- `Cargo.lock` - Dependency lock file (generated from Cargo.toml)
- `src/ffi/bridge.rs.cc` - Generated by cxx
- `src/ffi/bridge.rs.h` - Generated by cxx
- `*.rs.bk` - Rust backup files
- Build intermediates (*.o, *.a, etc.)

Only source files and configuration are tracked in git.

## Testing

```bash
# Run Rust tests
cargo test

# Run with output
cargo test -- --nocapture

# Run specific test
cargo test test_name
```

## Next Steps (Phase 3)

Replace stub implementations with real Zcash Orchard cryptography:

1. **Real Bundle Implementation**
   - Use `orchard::Bundle` from Zcash
   - Real proof generation/verification
   - Note encryption/decryption

2. **Merkle Tree Operations**
   - Note commitment tree
   - Anchor management
   - Path generation

3. **Key Management**
   - Spending keys
   - Viewing keys
   - Address derivation

4. **Transaction Building**
   - Action construction
   - Proof generation
   - Bundle assembly

## Documentation

- [Phase 2 Complete](../docs/OrchardPhase2Complete.md) - Rust skeleton implementation
- [Phase 4 Complete](../docs/OrchardPhase4Complete.md) - C++ transactor implementation
- [Value Balance Guide](../docs/OrchardValueBalance.md) - Value balance system
- [Transaction Verification](../docs/OrchardTransactionVerification.md) - Verification pipeline
- [Implementation Status](../docs/OrchardImplementationStatus.md) - Overall progress

## License

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

## Links

- [Zcash Orchard](https://zcash.github.io/orchard/) - Orchard specification
- [Halo2 Book](https://zcash.github.io/halo2/) - Halo2 proof system
- [cxx Documentation](https://cxx.rs/) - Rust/C++ FFI bridge
