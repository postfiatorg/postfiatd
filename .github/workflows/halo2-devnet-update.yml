name: Halo2 Devnet Update Nodes

on:
  workflow_dispatch:
    inputs:
      node_type:
        description: 'Node type to update'
        required: true
        type: choice
        options:
          - validators
          - rpc
          - archive
          - all
      image_tag_suffix:
        description: 'Optional image tag suffix to pin before update (latest or short SHA)'
        required: false
        default: ''
        type: string
      confirm_scope:
        description: 'Type HALO2_DEVNET_ONLY to confirm isolation from devnet/testnet'
        required: true
        default: HALO2_DEVNET_ONLY
        type: string

concurrency:
  group: halo2-devnet-lifecycle
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      validator_hosts: ${{ steps.prepare.outputs.validator_hosts }}
      rpc_hosts: ${{ steps.prepare.outputs.rpc_hosts }}
      archive_hosts: ${{ steps.prepare.outputs.archive_hosts }}
      has_archive_hosts: ${{ steps.prepare.outputs.has_archive_hosts }}
    steps:
      - name: Validate scope and resolve Halo2 hosts
        id: prepare
        env:
          INPUT_NODE_TYPE: ${{ inputs.node_type }}
          INPUT_CONFIRM_SCOPE: ${{ inputs.confirm_scope }}
          HALO2_VALIDATORS: ${{ vars.DEVNET_HALO2_VALIDATOR_HOSTS }}
          HALO2_RPC: ${{ vars.DEVNET_HALO2_RPC_HOSTS }}
          HALO2_ARCHIVE: ${{ vars.DEVNET_HALO2_ARCHIVE_HOSTS }}
          DEVNET_VALIDATORS: ${{ vars.DEVNET_VALIDATOR_HOSTS }}
          DEVNET_RPC: ${{ vars.DEVNET_RPC_HOSTS }}
          DEVNET_ARCHIVE: ${{ vars.DEVNET_ARCHIVE_HOSTS }}
          TESTNET_VALIDATORS: ${{ vars.TESTNET_VALIDATOR_HOSTS }}
          TESTNET_RPC: ${{ vars.TESTNET_RPC_HOSTS }}
          TESTNET_ARCHIVE: ${{ vars.TESTNET_ARCHIVE_HOSTS }}
        run: |
          set -euo pipefail

          if [ "${INPUT_CONFIRM_SCOPE}" != "HALO2_DEVNET_ONLY" ]; then
            echo "confirm_scope must be HALO2_DEVNET_ONLY"
            exit 1
          fi

          python3 - <<'PY'
          import json
          import os
          import sys

          out_file = os.environ["GITHUB_OUTPUT"]

          def fail(msg: str) -> None:
            print(msg)
            sys.exit(1)

          def parse_hosts(name: str, required: bool = False):
            raw = (os.environ.get(name, "") or "").strip()
            if not raw:
              if required:
                fail(f"Missing required variable: {name}")
              return []
            try:
              parsed = json.loads(raw)
            except Exception as exc:
              fail(f"Invalid JSON in {name}: {exc}")
            if not isinstance(parsed, list) or any(not isinstance(i, str) or not i.strip() for i in parsed):
              fail(f"{name} must be a JSON array of non-empty strings")
            return [i.strip() for i in parsed]

          node_type = (os.environ.get("INPUT_NODE_TYPE", "") or "").strip()
          if node_type not in {"validators", "rpc", "archive", "all"}:
            fail(f"Unsupported node_type: {node_type}")

          halo2_validators = parse_hosts("HALO2_VALIDATORS", required=False)
          halo2_rpc = parse_hosts("HALO2_RPC", required=False)
          halo2_archive = parse_hosts("HALO2_ARCHIVE", required=False)

          validator_set = set(halo2_validators)
          rpc_set = set(halo2_rpc)
          archive_set = set(halo2_archive)
          role_overlap = sorted(
              (validator_set & rpc_set)
              | (validator_set & archive_set)
              | (rpc_set & archive_set)
          )
          if role_overlap:
            fail(
              "Halo2 host overlap detected across validator/rpc/archive roles: "
              + ", ".join(role_overlap)
            )

          devnet_validators = parse_hosts("DEVNET_VALIDATORS", required=False)
          devnet_rpc = parse_hosts("DEVNET_RPC", required=False)
          devnet_archive = parse_hosts("DEVNET_ARCHIVE", required=False)
          testnet_validators = parse_hosts("TESTNET_VALIDATORS", required=False)
          testnet_rpc = parse_hosts("TESTNET_RPC", required=False)
          testnet_archive = parse_hosts("TESTNET_ARCHIVE", required=False)

          halo2_hosts = set(halo2_validators + halo2_rpc + halo2_archive)
          legacy_hosts = set(
              devnet_validators
              + devnet_rpc
              + devnet_archive
              + testnet_validators
              + testnet_rpc
              + testnet_archive
          )

          overlap = sorted(halo2_hosts.intersection(legacy_hosts))
          if overlap:
            fail(
              "Halo2 host overlap detected with live devnet/testnet inventory: "
              + ", ".join(overlap)
            )

          if node_type in {"validators", "all"} and not halo2_validators:
            fail("No Halo2 validator hosts configured")
          if node_type in {"rpc", "all"} and not halo2_rpc:
            fail("No Halo2 RPC hosts configured")
          if node_type == "archive" and not halo2_archive:
            fail("No Halo2 archive hosts configured")

          values = {
            "validator_hosts": json.dumps(halo2_validators),
            "rpc_hosts": json.dumps(halo2_rpc),
            "archive_hosts": json.dumps(halo2_archive),
            "has_archive_hosts": "true" if halo2_archive else "false",
          }

          with open(out_file, "a", encoding="utf-8") as fh:
            for key, value in values.items():
              fh.write(f"{key}={value}\n")
          PY

  update-validator:
    if: ${{ inputs.node_type == 'validators' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.validator_hosts) }}
    steps:
      - name: Update Halo2 validator ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_TAG_SUFFIX: ${{ inputs.image_tag_suffix }}
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          envs: IMAGE_TAG_SUFFIX
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2

            cd "${BASE_DIR}"

            if [ ! -f docker-compose.yml ]; then
              echo "Missing ${BASE_DIR}/docker-compose.yml. Run halo2-devnet-deploy first."
              exit 1
            fi

            if [ -n "${IMAGE_TAG_SUFFIX}" ]; then
              sed -i -E "s#(image:[[:space:]]+agtipft/postfiatd:devnet-halo2-light-).*#\\1${IMAGE_TAG_SUFFIX}#" docker-compose.yml
            fi

            docker compose --project-name "${PROJECT_NAME}" pull
            docker compose --project-name "${PROJECT_NAME}" up -d

            echo "Waiting for Halo2 validator to start..."
            sleep 30

            if docker exec "${CONTAINER_NAME}" postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "Halo2 validator is healthy"
            else
              echo "Warning: Halo2 validator health check inconclusive"
            fi

  update-rpc:
    if: ${{ always() && (inputs.node_type == 'rpc' || inputs.node_type == 'all') && !cancelled() }}
    needs: [prepare, update-validator]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.rpc_hosts) }}
    steps:
      - name: Update Halo2 RPC ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_TAG_SUFFIX: ${{ inputs.image_tag_suffix }}
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          envs: IMAGE_TAG_SUFFIX
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2

            cd "${BASE_DIR}"

            if [ ! -f docker-compose.yml ]; then
              echo "Missing ${BASE_DIR}/docker-compose.yml. Run halo2-devnet-deploy first."
              exit 1
            fi

            if [ -n "${IMAGE_TAG_SUFFIX}" ]; then
              sed -i -E "s#(image:[[:space:]]+agtipft/postfiatd:devnet-halo2-medium-).*#\\1${IMAGE_TAG_SUFFIX}#" docker-compose.yml
            fi

            docker compose --project-name "${PROJECT_NAME}" pull
            docker compose --project-name "${PROJECT_NAME}" up -d

            echo "Waiting for Halo2 RPC to start..."
            sleep 30

            if docker exec "${CONTAINER_NAME}" postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "Halo2 RPC is healthy"
            else
              echo "Warning: Halo2 RPC health check inconclusive"
            fi

  update-archive:
    if: ${{ always() && (inputs.node_type == 'archive' || inputs.node_type == 'all') && needs.prepare.outputs.has_archive_hosts == 'true' && !cancelled() }}
    needs: [prepare, update-validator]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.archive_hosts) }}
    steps:
      - name: Update Halo2 archive ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_TAG_SUFFIX: ${{ inputs.image_tag_suffix }}
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          envs: IMAGE_TAG_SUFFIX
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2

            cd "${BASE_DIR}"

            if [ ! -f docker-compose.yml ]; then
              echo "Missing ${BASE_DIR}/docker-compose.yml. Run halo2-devnet-deploy first."
              exit 1
            fi

            if [ -n "${IMAGE_TAG_SUFFIX}" ]; then
              sed -i -E "s#(image:[[:space:]]+agtipft/postfiatd:devnet-halo2-full-).*#\\1${IMAGE_TAG_SUFFIX}#" docker-compose.yml
            fi

            docker compose --project-name "${PROJECT_NAME}" pull
            docker compose --project-name "${PROJECT_NAME}" up -d

            echo "Waiting for Halo2 archive to start..."
            sleep 30

            if docker exec "${CONTAINER_NAME}" postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "Halo2 archive is healthy"
            else
              echo "Warning: Halo2 archive health check inconclusive"
            fi
