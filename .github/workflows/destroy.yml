name: Destroy Node Data
on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to destroy'
        required: true
        type: choice
        options:
          - devnet
          - testnet
      node_type:
        description: 'Node type to destroy'
        required: true
        type: choice
        options:
          - validators
          - rpc
          - all

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      validator_hosts: ${{ steps.hosts.outputs.validator_hosts }}
      rpc_hosts: ${{ steps.hosts.outputs.rpc_hosts }}
    steps:
      - name: Set hosts based on network
        id: hosts
        env:
          DEVNET_VALIDATORS: ${{ vars.DEVNET_VALIDATOR_HOSTS }}
          DEVNET_RPC: ${{ vars.DEVNET_RPC_HOSTS }}
          TESTNET_VALIDATORS: ${{ vars.TESTNET_VALIDATOR_HOSTS }}
          TESTNET_RPC: ${{ vars.TESTNET_RPC_HOSTS }}
        run: |
          if [ "${{ inputs.network }}" = "devnet" ]; then
            echo "validator_hosts=$DEVNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$DEVNET_RPC" >> $GITHUB_OUTPUT
          else
            echo "validator_hosts=$TESTNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$TESTNET_RPC" >> $GITHUB_OUTPUT
          fi

  destroy-validator:
    if: ${{ inputs.node_type == 'validators' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.validator_hosts) }}
    steps:
      - name: Destroy data on validator ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -e

            cd /opt/postfiatd 2>/dev/null || true

            docker compose down --volumes --remove-orphans 2>/dev/null || true

            # Remove volumes with project prefix (postfiatd_)
            docker volume ls -q --filter name=postfiatd | xargs -r docker volume rm 2>/dev/null || true

            docker system prune -af 2>/dev/null || true

            rm -rf /opt/postfiatd

            echo "Data destroyed on validator ${{ matrix.host }}"

  destroy-rpc:
    if: ${{ inputs.node_type == 'rpc' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.rpc_hosts) }}
    steps:
      - name: Destroy data on RPC ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -e

            cd /opt/postfiatd 2>/dev/null || true

            docker compose down --volumes --remove-orphans 2>/dev/null || true

            # Remove volumes with project prefix (postfiatd_)
            docker volume ls -q --filter name=postfiatd | xargs -r docker volume rm 2>/dev/null || true

            docker system prune -af 2>/dev/null || true

            rm -rf /opt/postfiatd

            # Stop Caddy and remove config (but keep Caddy installed)
            systemctl stop caddy 2>/dev/null || true
            rm -f /etc/caddy/Caddyfile

            echo "Data destroyed on RPC ${{ matrix.host }}"
