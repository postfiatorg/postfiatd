name: Halo2 Devnet Destroy Node Data

on:
  workflow_dispatch:
    inputs:
      node_type:
        description: 'Node type to destroy'
        required: true
        type: choice
        options:
          - validators
          - rpc
          - archive
          - all
      confirm_scope:
        description: 'Type HALO2_DEVNET_ONLY to confirm isolation from devnet/testnet'
        required: true
        default: HALO2_DEVNET_ONLY
        type: string
      confirm_destroy:
        description: 'Type DESTROY_HALO2_DEVNET to confirm destructive action'
        required: true
        default: DESTROY_HALO2_DEVNET
        type: string

concurrency:
  group: halo2-devnet-lifecycle
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      validator_hosts: ${{ steps.prepare.outputs.validator_hosts }}
      rpc_hosts: ${{ steps.prepare.outputs.rpc_hosts }}
      archive_hosts: ${{ steps.prepare.outputs.archive_hosts }}
      has_archive_hosts: ${{ steps.prepare.outputs.has_archive_hosts }}
    steps:
      - name: Validate scope and resolve Halo2 hosts
        id: prepare
        env:
          INPUT_NODE_TYPE: ${{ inputs.node_type }}
          INPUT_CONFIRM_SCOPE: ${{ inputs.confirm_scope }}
          INPUT_CONFIRM_DESTROY: ${{ inputs.confirm_destroy }}
          HALO2_VALIDATORS: ${{ vars.DEVNET_HALO2_VALIDATOR_HOSTS }}
          HALO2_RPC: ${{ vars.DEVNET_HALO2_RPC_HOSTS }}
          HALO2_ARCHIVE: ${{ vars.DEVNET_HALO2_ARCHIVE_HOSTS }}
          DEVNET_VALIDATORS: ${{ vars.DEVNET_VALIDATOR_HOSTS }}
          DEVNET_RPC: ${{ vars.DEVNET_RPC_HOSTS }}
          DEVNET_ARCHIVE: ${{ vars.DEVNET_ARCHIVE_HOSTS }}
          TESTNET_VALIDATORS: ${{ vars.TESTNET_VALIDATOR_HOSTS }}
          TESTNET_RPC: ${{ vars.TESTNET_RPC_HOSTS }}
          TESTNET_ARCHIVE: ${{ vars.TESTNET_ARCHIVE_HOSTS }}
        run: |
          set -euo pipefail

          if [ "${INPUT_CONFIRM_SCOPE}" != "HALO2_DEVNET_ONLY" ]; then
            echo "confirm_scope must be HALO2_DEVNET_ONLY"
            exit 1
          fi
          if [ "${INPUT_CONFIRM_DESTROY}" != "DESTROY_HALO2_DEVNET" ]; then
            echo "confirm_destroy must be DESTROY_HALO2_DEVNET"
            exit 1
          fi

          python3 - <<'PY'
          import json
          import os
          import sys

          out_file = os.environ["GITHUB_OUTPUT"]

          def fail(msg: str) -> None:
            print(msg)
            sys.exit(1)

          def parse_hosts(name: str, required: bool = False):
            raw = (os.environ.get(name, "") or "").strip()
            if not raw:
              if required:
                fail(f"Missing required variable: {name}")
              return []
            try:
              parsed = json.loads(raw)
            except Exception as exc:
              fail(f"Invalid JSON in {name}: {exc}")
            if not isinstance(parsed, list) or any(not isinstance(i, str) or not i.strip() for i in parsed):
              fail(f"{name} must be a JSON array of non-empty strings")
            return [i.strip() for i in parsed]

          node_type = (os.environ.get("INPUT_NODE_TYPE", "") or "").strip()
          if node_type not in {"validators", "rpc", "archive", "all"}:
            fail(f"Unsupported node_type: {node_type}")

          halo2_validators = parse_hosts("HALO2_VALIDATORS", required=False)
          halo2_rpc = parse_hosts("HALO2_RPC", required=False)
          halo2_archive = parse_hosts("HALO2_ARCHIVE", required=False)

          validator_set = set(halo2_validators)
          rpc_set = set(halo2_rpc)
          archive_set = set(halo2_archive)
          role_overlap = sorted(
              (validator_set & rpc_set)
              | (validator_set & archive_set)
              | (rpc_set & archive_set)
          )
          if role_overlap:
            fail(
              "Halo2 host overlap detected across validator/rpc/archive roles: "
              + ", ".join(role_overlap)
            )

          devnet_validators = parse_hosts("DEVNET_VALIDATORS", required=False)
          devnet_rpc = parse_hosts("DEVNET_RPC", required=False)
          devnet_archive = parse_hosts("DEVNET_ARCHIVE", required=False)
          testnet_validators = parse_hosts("TESTNET_VALIDATORS", required=False)
          testnet_rpc = parse_hosts("TESTNET_RPC", required=False)
          testnet_archive = parse_hosts("TESTNET_ARCHIVE", required=False)

          halo2_hosts = set(halo2_validators + halo2_rpc + halo2_archive)
          legacy_hosts = set(
              devnet_validators
              + devnet_rpc
              + devnet_archive
              + testnet_validators
              + testnet_rpc
              + testnet_archive
          )

          overlap = sorted(halo2_hosts.intersection(legacy_hosts))
          if overlap:
            fail(
              "Halo2 host overlap detected with live devnet/testnet inventory: "
              + ", ".join(overlap)
            )

          if node_type in {"validators", "all"} and not halo2_validators:
            fail("No Halo2 validator hosts configured")
          if node_type in {"rpc", "all"} and not halo2_rpc:
            fail("No Halo2 RPC hosts configured")
          if node_type == "archive" and not halo2_archive:
            fail("No Halo2 archive hosts configured")

          values = {
            "validator_hosts": json.dumps(halo2_validators),
            "rpc_hosts": json.dumps(halo2_rpc),
            "archive_hosts": json.dumps(halo2_archive),
            "has_archive_hosts": "true" if halo2_archive else "false",
          }

          with open(out_file, "a", encoding="utf-8") as fh:
            for key, value in values.items():
              fh.write(f"{key}={value}\n")
          PY

  destroy-validator:
    if: ${{ inputs.node_type == 'validators' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.validator_hosts) }}
    steps:
      - name: Destroy data on Halo2 validator ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2
            PROMTAIL_NAME=promtail-halo2

            cd "${BASE_DIR}" 2>/dev/null || true
            docker compose --project-name "${PROJECT_NAME}" down --volumes --remove-orphans 2>/dev/null || true
            docker rm -f "${CONTAINER_NAME}" "${PROMTAIL_NAME}" 2>/dev/null || true
            docker volume ls -q --filter "name=${PROJECT_NAME}" | xargs -r docker volume rm 2>/dev/null || true
            docker system prune -af 2>/dev/null || true
            rm -rf "${BASE_DIR}"

            echo "Data destroyed on Halo2 validator ${{ matrix.host }}"

  destroy-rpc:
    if: ${{ inputs.node_type == 'rpc' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.rpc_hosts) }}
    steps:
      - name: Destroy data on Halo2 RPC ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2
            PROMTAIL_NAME=promtail-halo2

            cd "${BASE_DIR}" 2>/dev/null || true
            docker compose --project-name "${PROJECT_NAME}" down --volumes --remove-orphans 2>/dev/null || true
            docker rm -f "${CONTAINER_NAME}" "${PROMTAIL_NAME}" 2>/dev/null || true
            docker volume ls -q --filter "name=${PROJECT_NAME}" | xargs -r docker volume rm 2>/dev/null || true
            docker system prune -af 2>/dev/null || true
            rm -rf "${BASE_DIR}"

            if [ -f /etc/caddy/Caddyfile ] && grep -q "Managed by halo2-devnet-deploy.yml" /etc/caddy/Caddyfile; then
              systemctl stop caddy 2>/dev/null || true
              rm -f /etc/caddy/Caddyfile
              echo "Removed Halo2-managed Caddy config"
            else
              echo "Skipping Caddy cleanup: /etc/caddy/Caddyfile not managed by Halo2 workflow"
            fi

            echo "Data destroyed on Halo2 RPC ${{ matrix.host }}"

  destroy-archive:
    if: ${{ always() && (inputs.node_type == 'archive' || inputs.node_type == 'all') && needs.prepare.outputs.has_archive_hosts == 'true' && !cancelled() }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.archive_hosts) }}
    steps:
      - name: Destroy data on Halo2 archive ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -euo pipefail

            BASE_DIR=/opt/postfiatd-halo2
            PROJECT_NAME=postfiatd-halo2
            CONTAINER_NAME=postfiatd-halo2
            PROMTAIL_NAME=promtail-halo2

            cd "${BASE_DIR}" 2>/dev/null || true
            docker compose --project-name "${PROJECT_NAME}" down --volumes --remove-orphans 2>/dev/null || true
            docker rm -f "${CONTAINER_NAME}" "${PROMTAIL_NAME}" 2>/dev/null || true
            docker volume ls -q --filter "name=${PROJECT_NAME}" | xargs -r docker volume rm 2>/dev/null || true
            docker system prune -af 2>/dev/null || true
            rm -rf "${BASE_DIR}"

            if [ -f /etc/caddy/Caddyfile ] && grep -q "Managed by halo2-devnet-deploy.yml" /etc/caddy/Caddyfile; then
              systemctl stop caddy 2>/dev/null || true
              rm -f /etc/caddy/Caddyfile
              echo "Removed Halo2-managed Caddy config"
            else
              echo "Skipping Caddy cleanup: /etc/caddy/Caddyfile not managed by Halo2 workflow"
            fi

            echo "Data destroyed on Halo2 archive ${{ matrix.host }}"
