name: Update Nodes
on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to update'
        required: true
        type: choice
        options:
          - devnet
          - testnet
      node_type:
        description: 'Node type to update'
        required: true
        type: choice
        options:
          - validators
          - rpc
          - all
      run_orchard_smoke:
        description: 'Run Orchard t_to_z smoke tx on one validator (devnet validators only)'
        required: false
        type: boolean
        default: false
      smoke_validator_host:
        description: 'Validator host that executes smoke tx when run_orchard_smoke=true'
        required: false
        type: string
        default: '66.135.27.77'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      validator_hosts: ${{ steps.hosts.outputs.validator_hosts }}
      rpc_hosts: ${{ steps.hosts.outputs.rpc_hosts }}
    steps:
      - name: Set hosts based on network
        id: hosts
        env:
          DEVNET_VALIDATORS: ${{ vars.DEVNET_VALIDATOR_HOSTS }}
          DEVNET_RPC: ${{ vars.DEVNET_RPC_HOSTS }}
          TESTNET_VALIDATORS: ${{ vars.TESTNET_VALIDATOR_HOSTS }}
          TESTNET_RPC: ${{ vars.TESTNET_RPC_HOSTS }}
        run: |
          if [ "${{ inputs.network }}" = "devnet" ]; then
            echo "validator_hosts=$DEVNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$DEVNET_RPC" >> $GITHUB_OUTPUT
          else
            echo "validator_hosts=$TESTNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$TESTNET_RPC" >> $GITHUB_OUTPUT
          fi

  update-validator:
    if: ${{ inputs.node_type == 'validators' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.validator_hosts) }}
    steps:
      - name: Update validator ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        env:
          RUN_ORCHARD_SMOKE: ${{ inputs.run_orchard_smoke }}
          SMOKE_VALIDATOR_HOST: ${{ inputs.smoke_validator_host }}
          DEPLOY_HOST: ${{ matrix.host }}
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          envs: RUN_ORCHARD_SMOKE,SMOKE_VALIDATOR_HOST,DEPLOY_HOST
          script: |
            set -e

            cd /opt/postfiatd

            docker compose pull
            docker compose up -d

            echo "Waiting for postfiatd to start..."
            sleep 30

            if docker exec postfiatd postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "postfiatd is healthy"
            else
              echo "Warning: postfiatd health check inconclusive, container may still be starting"
            fi

            if [ "${{ inputs.network }}" = "devnet" ]; then
              echo "Forcing OrchardPrivacy amendment vote to ACCEPT on devnet validator..."
              docker exec postfiatd postfiatd --conf /etc/postfiatd/postfiatd.cfg feature OrchardPrivacy accept || true
            fi

            if [ "${{ inputs.network }}" = "devnet" ] && [ "${RUN_ORCHARD_SMOKE}" = "true" ] && [ "${DEPLOY_HOST}" = "${SMOKE_VALIDATOR_HOST}" ]; then
              echo "Running Orchard smoke transaction on validator ${DEPLOY_HOST}..."
              python3 - << 'PY'
              import json
              import ssl
              import time
              import urllib.request

              url = "https://localhost:5005/"
              headers = {"Content-Type": "application/json"}
              ctx = ssl._create_unverified_context()
              secret = "snoPBrXtMeMyMHUVTgbuqAfg1SUTb"
              source_account = "rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh"

              def rpc(method, params):
                  body = json.dumps({"method": method, "params": params}).encode()
                  req = urllib.request.Request(url, data=body, headers=headers)
                  with urllib.request.urlopen(req, timeout=30, context=ctx) as resp:
                      return json.load(resp)

              feature = rpc("feature", [{"feature": "OrchardPrivacy"}])
              info = feature["result"]["FFAB002FD32A4CFE1FA902D8A5F507B8B0E860716FC578E1E0BD6DB665BAABAA"]
              if not info.get("enabled"):
                  raise SystemExit("OrchardPrivacy is not enabled on smoke validator")

              keys = rpc("orchard_generate_keys", [{}])
              recipient = keys["result"]["address"]
              print(f"ORCHARD_SMOKE_RECIPIENT={recipient}")

              prep = rpc(
                  "orchard_prepare_payment",
                  [{
                      "payment_type": "t_to_z",
                      "source_account": source_account,
                      "recipient": recipient,
                      "amount": "1000000"
                  }],
              )

              if prep.get("result", {}).get("status") != "success":
                  raise SystemExit("orchard_prepare_payment failed: " + json.dumps(prep))

              submit = rpc(
                  "submit",
                  [{
                      "tx_json": prep["result"]["tx_json"],
                      "secret": secret
                  }],
              )

              result = submit.get("result", {})
              tx_hash = result.get("tx_json", {}).get("hash")
              engine_result = result.get("engine_result")
              print(f"ORCHARD_SMOKE_ENGINE_RESULT={engine_result}")
              print(f"ORCHARD_SMOKE_TX_HASH={tx_hash}")

              if not tx_hash:
                  raise SystemExit("submit returned no hash: " + json.dumps(submit))
              if engine_result != "tesSUCCESS":
                  raise SystemExit("submit failed: " + json.dumps(submit))

              validated = False
              for _ in range(40):
                  tx = rpc("tx", [{"transaction": tx_hash}])
                  if tx.get("result", {}).get("validated"):
                      validated = True
                      print(f"ORCHARD_SMOKE_VALIDATED_LEDGER={tx['result'].get('ledger_index')}")
                      break
                  time.sleep(2)

              if not validated:
                  raise SystemExit("transaction was not validated in time")

              print("ORCHARD_SMOKE_STATUS=SUCCESS")
              PY
            fi

  update-rpc:
    if: ${{ inputs.node_type == 'rpc' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.rpc_hosts) }}
    steps:
      - name: Update RPC ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -e

            cd /opt/postfiatd

            docker compose pull
            docker compose up -d

            echo "Waiting for postfiatd to start..."
            sleep 30

            if docker exec postfiatd postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "postfiatd is healthy"
            else
              echo "Warning: postfiatd health check inconclusive, container may still be starting"
            fi
