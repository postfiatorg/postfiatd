name: Update Nodes
on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to update'
        required: true
        type: choice
        options:
          - devnet
          - testnet
      node_type:
        description: 'Node type to update'
        required: true
        type: choice
        options:
          - validators
          - rpc
          - all

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      validator_hosts: ${{ steps.hosts.outputs.validator_hosts }}
      rpc_hosts: ${{ steps.hosts.outputs.rpc_hosts }}
    steps:
      - name: Set hosts based on network
        id: hosts
        env:
          DEVNET_VALIDATORS: ${{ vars.DEVNET_VALIDATOR_HOSTS }}
          DEVNET_RPC: ${{ vars.DEVNET_RPC_HOSTS }}
          TESTNET_VALIDATORS: ${{ vars.TESTNET_VALIDATOR_HOSTS }}
          TESTNET_RPC: ${{ vars.TESTNET_RPC_HOSTS }}
        run: |
          if [ "${{ inputs.network }}" = "devnet" ]; then
            echo "validator_hosts=$DEVNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$DEVNET_RPC" >> $GITHUB_OUTPUT
          else
            echo "validator_hosts=$TESTNET_VALIDATORS" >> $GITHUB_OUTPUT
            echo "rpc_hosts=$TESTNET_RPC" >> $GITHUB_OUTPUT
          fi

  update-validator:
    if: ${{ inputs.node_type == 'validators' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.validator_hosts) }}
    steps:
      - name: Update validator ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -e

            cd /opt/postfiatd

            docker compose pull
            docker compose up -d

            echo "Waiting for postfiatd to start..."
            sleep 30

            if docker exec postfiatd postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "postfiatd is healthy"
            else
              echo "Warning: postfiatd health check inconclusive, container may still be starting"
            fi

            if [ "${{ inputs.network }}" = "devnet" ]; then
              echo "Forcing OrchardPrivacy amendment vote to ACCEPT on devnet validator..."
              docker exec postfiatd postfiatd feature OrchardPrivacy accept || true
            fi

  update-rpc:
    if: ${{ inputs.node_type == 'rpc' || inputs.node_type == 'all' }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.prepare.outputs.rpc_hosts) }}
    steps:
      - name: Update RPC ${{ matrix.host }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ matrix.host }}
          username: root
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            set -e

            cd /opt/postfiatd

            docker compose pull
            docker compose up -d

            echo "Waiting for postfiatd to start..."
            sleep 30

            if docker exec postfiatd postfiatd server_info 2>/dev/null | grep -q "server_state"; then
              echo "postfiatd is healthy"
            else
              echo "Warning: postfiatd health check inconclusive, container may still be starting"
            fi
